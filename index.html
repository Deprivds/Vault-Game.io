<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Constellation Cipher Game</title>

  <!-- =========================
       STYLES
  ========================== -->
  <style>
    body {
      font-family: Arial, sans-serif;
      background: url("background-space.gif") no-repeat center center fixed;
      background-size: cover;
      color: white;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      position: relative;
    }

    h1 {
      color: #ffd700;
      margin-bottom: 20px;
    }

    #constellation {
      max-width: 80%;
      max-height: 400px;
      margin-bottom: 30px;
      border: 2px solid #444;
      border-radius: 10px;
      display: block;
    }

    input[type="text"] {
      padding: 10px;
      font-size: 16px;
      border-radius: 5px;
      border: none;
      margin-bottom: 10px;
      text-align: center;
      width: 250px;
    }

    button {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background: #ffd700;
    }

    #result {
      margin-top: 15px;
      font-size: 18px;
    }

    /* Hidden star button */
    #adminStar {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 24px;
      color: transparent;
      background: none;
      border: none;
      cursor: pointer;
    }
    #adminStar:hover {
      color: #ffd700;
    }
  </style>
</head>
<body>
  <!-- =========================
       GAME INTERFACE
  ========================== -->
  <h1>✨ Constellation Cipher ✨</h1>

  <!-- Constellation image -->
  <img id="constellation" src="" alt="Constellation">

  <!-- Player input -->
  <input type="text" id="playerAnswer" placeholder="Enter your answer..." autofocus>
  <button id="submitBtn">Submit</button>

  <!-- Result message -->
  <p id="result"></p>

  <!-- Hidden Star Button -->
  <button id="adminStar" onclick="goAdmin()">★</button>

  
  <!-- =========================
       JAVASCRIPT LOGIC
  ========================== -->
  <script>
    /* -------------------------
       CONSTELLATION HANDLING
    ------------------------- */
    const cameFromAdmin = localStorage.getItem("backFromAdmin") === "true";

    // If NOT coming from Admin, reset constellation so refresh always gets a new one
    if (!cameFromAdmin) {
      localStorage.removeItem("cipherStar");
      localStorage.removeItem("cipherAnswerCW");
      localStorage.removeItem("cipherAnswerCCW");
    } else {
      // Clear the flag so next refresh works normally
      localStorage.removeItem("backFromAdmin");
    }

    // Images for each constellation
    const starBackgrounds = {
      "Aries": "Aries.jpg",
      "Taurus": "Taurus.jpg",
      "Gemini": "Gemini.jpg",
      "Cancer": "Cancer.jpg",
      "Leo": "Leo.jpg",
      "Virgo": "Virgo.jpg",
      "Libra": "Libra.jpg",
      "Scorpio": "Scorpio.jpg",
      "Sagittarius": "Sagittarius.jpg",
      "Capricorn": "Capricorn.jpg",
      "Aquarius": "Aquarius.jpg",
      "Pisces": "Pisces.jpg"
    };

    // Star counts (used for Caesar shift)
    const constellationCounts = {
      "Aries": 5,
      "Taurus": 11,
      "Gemini": 8,
      "Cancer": 5,
      "Leo": 9,
      "Virgo": 9,
      "Libra": 8,
      "Scorpio": 14,
      "Sagittarius": 20,
      "Capricorn": 9,
      "Aquarius": 11,
      "Pisces": 20
    };

    // Caesar cipher helper
    function caesarShift(str, shift) {
      return str.split("").map(char => {
        if (/[a-z]/.test(char)) {
          let code = char.charCodeAt(0) - 97;
          return String.fromCharCode(((code + shift + 26) % 26) + 97);
        } else if (/[A-Z]/.test(char)) {
          let code = char.charCodeAt(0) - 65;
          return String.fromCharCode(((code + shift + 26) % 26) + 65);
        }
        return char;
      }).join("");
    }

    // Step 1: Check if a star is already stored
    let chosenStar = localStorage.getItem("cipherStar");

    // Step 2: If not stored yet, randomize and store constellation + answers
    if (!chosenStar) {
      const constellationKeys = Object.keys(starBackgrounds);
      chosenStar = constellationKeys[Math.floor(Math.random() * constellationKeys.length)];
      localStorage.setItem("cipherStar", chosenStar);

      let starCount = constellationCounts[chosenStar];
      let cw = caesarShift(chosenStar, starCount);
      let ccw = caesarShift(chosenStar, -starCount);

      // 🔹 Always overwrite in case numbers changed
      localStorage.setItem("cipherAnswerCW", cw);
      localStorage.setItem("cipherAnswerCCW", ccw);

      console.log("Generated answers:", cw, ccw);
    } else {
      // 🔹 If constellation is already chosen, force re-sync with numbers
      let starCount = constellationCounts[chosenStar];
      let cw = caesarShift(chosenStar, starCount);
      let ccw = caesarShift(chosenStar, -starCount);
      localStorage.setItem("cipherAnswerCW", cw);
      localStorage.setItem("cipherAnswerCCW", ccw);
    }


    // Step 3: Show the chosen constellation
    const imgEl = document.getElementById("constellation");
    imgEl.src = starBackgrounds[chosenStar];
    imgEl.alt = chosenStar;

    console.log("Current constellation:", chosenStar);


    /* -------------------------
       ANSWER CHECKING
    ------------------------- */
    const inputEl = document.getElementById("playerAnswer");
    const resultEl = document.getElementById("result");
    const submitBtn = document.getElementById("submitBtn");

    function checkAnswer() {
      const input = inputEl.value.trim().toLowerCase();
      if (!input) {
        resultEl.textContent = "✳️ Please enter an answer.";
        resultEl.style.color = "#ffd700";
        return;
      }

      // Build accepted answers
      const storedCW = localStorage.getItem("cipherAnswerCW");
      const storedCCW = localStorage.getItem("cipherAnswerCCW");
      const legacy = localStorage.getItem("cipherAnswer"); // compatibility

      let acceptedAnswers = [];
      if (storedCW) acceptedAnswers.push(storedCW.toLowerCase().trim());
      if (storedCCW) acceptedAnswers.push(storedCCW.toLowerCase().trim());
      if (legacy) acceptedAnswers.push(legacy.toLowerCase().trim());
      if (acceptedAnswers.length === 0) acceptedAnswers.push("victory");

      acceptedAnswers = [...new Set(acceptedAnswers)];

      // Correct branch
      if (acceptedAnswers.includes(input)) {
        localStorage.setItem('vaultAccess', 'true'); // mark vault unlocked
        resultEl.textContent = "✅ Correct! Opening vault...";
        resultEl.style.color = "#00ff00";
        try { new Audio("https://www.soundjay.com/buttons/sounds/button-3.mp3").play(); } catch(e) {}

        setTimeout(() => {
          window.location.href = "vault_hack.html";
        }, 700);
      } else {
        // Wrong answer
        resultEl.textContent = "❌ Wrong! Try again.";
        resultEl.style.color = "#ff4444";
        try { new Audio("https://www.soundjay.com/buttons/sounds/button-10.mp3").play(); } catch(e) {}
      }
    }

    // Events
    submitBtn.addEventListener("click", checkAnswer);
    inputEl.addEventListener("keydown", e => {
      if (e.key === "Enter") checkAnswer();
    });

    /* -------------------------
       ADMIN NAVIGATION
    ------------------------- */
    function goAdmin() {
      window.location.href = "Admin.html";
    }
  </script>
</body>
</html>